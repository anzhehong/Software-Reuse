# 讨论课2
> 2016.4.23
> 
> Created by Sophie

## 讨论内容

> 参考业界架构，讨论程序的扩展
> 
> 1. 分布式：高可用性、高吞吐量
> 
> 2. 数据存储，分区，一致性，缓存
> 
> 3. 负载均衡
> 
> 4. ID分配
> 
> 5. 通信可靠高效
> 
> 6. 协议
> 
> 7. 消息队列
> 
> 8. 垃圾消息过滤
> 
> 9. 安全
> 

***

基于上述要求，我进行了下面的学习。


## 详细资料

### 查询业界目前比较流行的分布式消息系统架构：阿里巴巴ONS

Kafka是一个消息系统，原本开发自LinkedIn，用作LinkedIn的活动流（Activity Stream）和运营数据处理管道（Pipeline）的基础。现在它已被多家不同类型的公司 作为多种类型的数据管道和消息系统使用。

Kafka是一种分布式的，基于发布/订阅的消息系统。主要设计目标如下：

以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间复杂度的访问性能。
高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条以上消息的传输。
支持Kafka Server间的消息分区，及分布式消费，同时保证每个Partition内的消息顺序传输。
同时支持离线数据处理和实时数据处理。
Scale out：支持在线水平扩展。

###设计假定和关键设计

####设计假定

–  每台PC机器都可能down机不可服务
–  任意集群都可能处理能力不足
–  最坏情况一定会发生
–  内网环境需要低延迟来提供最佳用户体验

####关键设计

–  分布式集群化
–  强数据安全
–  海量数据堆积
–  毫秒级投递延迟
 
####无单点集群化设计

-  理论上无限的处理能力 
-  集群级别高可用

####海量数据堆积能力

-   任意集群都可能处理能力不足
-   消息堆积是常态
-   大量堆积,系统稳定,延迟不增,百亿级别的消息堆积能力
-   单消息Server不可用数据不丢
-  默认就是落磁盘策略,并针对磁盘吞吐做 了大量优化
-  集群可无限扩展,保证足够堆积能力

####毫秒级的投递延迟

-  采用长轮询/推送方式


### ONS的关键概念

##### Topic

-  第一级消息类型
-  书的标题
-  交易消息

#### Message type
-   第二级消息类型
–   方便检索使用
-   交易消息 

####ProducerID/ConsumerID
-   发送/接受机器的集群


###消息乱序问题

####产生原因
-   吞吐+容错

####有序队列优劣分析

–   容易理解
–   处理问题容易
–   并行度瓶颈 
–   异常处理
–   我们需要集群的容错性和高吞吐!


### 消息重复问题

####产生原因
-   网络不可达问题

####历史经验

–   幂等 – S*S = S （某个操作无论重复多少次,结果都一样）
-   非幂等消息去重（ 保证有个唯一ID标记每一条消息、保证消息处理成功与去去重表日志同时出现）


###分布式事务与ONS

####ONS消息与事物转账
-   如何保证消息发出与Bob账户减钱同时成功或 同时失败?
–   消息处理超时如何解决? 
–   消息处理失败如何解决?

####同时成功／同时失败（事务消息）

####处理超时问题

###参考资料

|参考资料名称|链接地址|
|:---:|:---:|
|阿里分布式消息系统ONS原理与实践|[http://wenku.baidu.com/link?url=yz8bEqrkv6-rKKUnkGZB5xyhun97mp3OacmLc36-uVqyUE9FKr-b0oEdnMVFzjZrNDPz5Prw5PvhaTJMaNjjdL7LUL5kyDTAqS4BsP8Vmte](http://wenku.baidu.com/link?url=yz8bEqrkv6-rKKUnkGZB5xyhun97mp3OacmLc36-uVqyUE9FKr-b0oEdnMVFzjZrNDPz5Prw5PvhaTJMaNjjdL7LUL5kyDTAqS4BsP8Vmte)|
